<html><head><base href=".">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistemas De Propinas by Isma</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
<!-- Animate.css -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

<style>
.currency-symbol {
    font-weight: bold;
    color: #2d4f83;
}

.dashboard-card {
    transition: transform 0.3s, box-shadow 0.3s;
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.dashboard-card.clickable {
  cursor: pointer;
  transition: transform 0.3s ease;
}

.dashboard-card.clickable:hover {
  transform: translateY(-5px);
}

.dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
}

.card-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.card-text {
    font-size: 1.8rem;
    font-weight: 700;
}

.currency-amount {
    display: block;
    margin-bottom: 0.5rem;
}

.currency-amount:last-child {
    margin-bottom: 0;
}

.sidebar {
    min-height: 100vh;
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
}

.nav-link {
    padding: 0.8rem 1rem;
    margin: 0.2rem 0;
    border-radius: 8px;
    transition: all 0.3s;
}

.nav-link:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.table {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
}

.modal-content {
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.form-select, .form-control {
    border-radius: 8px;
    border: 1px solid #dee2e6;
    padding: 0.75rem;
}

.btn {
    border-radius: 8px;
    padding: 0.5rem 1.5rem;
    font-weight: 600;
}

#loadingIndicator {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
}
</style>
</head>
<body class="bg-light">

<div id="loadingIndicator">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active text-white" href="#" data-bs-toggle="tab" data-bs-target="#dashboard">
                            <i class="fas fa-chart-line me-2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#" data-bs-toggle="tab" data-bs-target="#transactions">
                            <i class="fas fa-list me-2"></i> Transacciones
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#" data-bs-toggle="tab" data-bs-target="#pending">
                            <i class="fas fa-clock me-2"></i> Pendientes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#" data-bs-toggle="tab" data-bs-target="#reports">
                            <i class="fas fa-file-alt me-2"></i> Reportes
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="tab-content">
                <!-- Dashboard -->
                <div class="tab-pane fade show active" id="dashboard">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1>Dashboard</h1>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newTransactionModal">
                            <i class="fas fa-plus"></i> Nueva Entrada
                        </button>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <div class="card dashboard-card bg-primary text-white clickable">
                                <div class="card-body">
                                    <h5 class="card-title">Total del Mes</h5>
                                    <h2 class="card-text" id="monthlyTotal">&#x24;0.00</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card dashboard-card bg-success text-white clickable">
                                <div class="card-body">
                                    <h5 class="card-title">Ismael debe a Pedro</h5>
                                    <h2 class="card-text" id="ismaelDebt">&#x24;0.00</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card dashboard-card bg-info text-white clickable">
                                <div class="card-body">
                                    <h5 class="card-title">Pedro debe a Ismael</h5>
                                    <h2 class="card-text" id="pedroDebt">&#x24;0.00</h2>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="recent-transactions">
                        <h3>Transacciones Recientes</h3>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Receptor</th>
                                        <th>Tipo</th>
                                        <th>Monto</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="recentTransactionsTable">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="yearly-chart mt-4">
                        <div class="card dashboard-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h3 class="card-title">Total Acumulado por Mes</h3>
                                    <select id="yearSelector" class="form-select" style="width: auto;">
                                        <!-- Years will be populated dynamically -->
                                    </select>
                                </div>
                                <canvas id="yearlyChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="currency-dashboard mt-4">
                        <div class="row">
                            <!-- USD Dashboard Card -->
                            <div class="col-md-6 mb-4">
                                <div class="card dashboard-card">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">USD Dashboard</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="usdChart"></canvas>
                                        <div class="progress mt-3">
                                            <div id="usdProgress" class="progress-bar" role="progressbar"></div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-2">
                                            <small>Current: &#x24;<span id="usdCurrent">0</span></small>
                                            <small>Goal: &#x24;<span id="usdGoal">0</span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- DOP Dashboard Card -->
                            <div class="col-md-6 mb-4">
                                <div class="card dashboard-card">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">DOP Dashboard</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="dopChart"></canvas>
                                        <div class="progress mt-3">
                                            <div id="dopProgress" class="progress-bar bg-success" role="progressbar"></div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-2">
                                            <small>Current: RD&#x24;<span id="dopCurrent">0</span></small>
                                            <small>Goal: RD&#x24;<span id="dopGoal">0</span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- EUR Dashboard Card -->
                            <div class="col-md-6 mb-4">
                                <div class="card dashboard-card">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0">EUR Dashboard</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="eurChart"></canvas>
                                        <div class="progress mt-3">
                                            <div id="eurProgress" class="progress-bar bg-info" role="progressbar"></div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-2">
                                            <small>Current: &#x20ac;<span id="eurCurrent">0</span></small>
                                            <small>Goal: &#x20ac;<span id="eurGoal">0</span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- MXN Dashboard Card -->
                            <div class="col-md-6 mb-4">
                                <div class="card dashboard-card">
                                    <div class="card-header bg-warning text-dark">
                                        <h5 class="mb-0">MXN Dashboard</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="mxnChart"></canvas>
                                        <div class="progress mt-3">
                                            <div id="mxnProgress" class="progress-bar bg-warning" role="progressbar"></div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-2">
                                            <small>Current: MX&#x24;<span id="mxnCurrent">0</span></small>
                                            <small>Goal: MX&#x24;<span id="mxnGoal">0</span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Tab -->
                <div class="tab-pane fade" id="transactions">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1>Transacciones</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportTransactions">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select" id="filterReceiver">
                                <option value>Todos los Receptores</option>
                                <option value="Ismael">Ismael</option>
                                <option value="Nathanael">Pedro</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filterType">
                                <option value>Todos los Tipos</option>
                                <option value="tip">Propina</option>
                                <option value="commission">Comisi&#xf3;n</option>
                                <option value="sale">Venta</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filterStatus">
                                <option value>Todos los Estados</option>
                                <option value="pending">Pendiente</option>
                                <option value="paid">Pagado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filterCurrency">
                                <option value>Todas las Monedas</option>
                                <option value="USD">USD</option>
                                <option value="DOP">DOP</option>
                                <option value="EUR">EUR</option>
                                <option value="MXN">MXN</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha <i class="fas fa-sort"></i></th>
                                    <th>Receptor <i class="fas fa-sort"></i></th>
                                    <th>Tipo <i class="fas fa-sort"></i></th>
                                    <th>Monto <i class="fas fa-sort"></i></th>
                                    <th>Estado</th>
                                    <th>Observaciones</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody" data-sort data-direction>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pending Tab -->
                <div class="tab-pane fade" id="pending">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1>Transacciones Pendientes</h1>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Receptor</th>
                                    <th>Tipo</th>
                                    <th>Monto</th>
                                    <th>Observaciones</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="pendingTransactionsTable">
                                <!-- Pending transactions will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div class="tab-pane fade" id="reports">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1>Reportes</h1>
                    </div>

                    <div class="card dashboard-card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Filtros de Reporte</h5>
                            <form id="reportForm" class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Fecha Inicial</label>
                                    <input type="date" class="form-control" id="startDate" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Fecha Final</label>
                                    <input type="date" class="form-control" id="endDate" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Moneda</label>
                                    <select class="form-select" id="reportCurrency">
                                        <option value>Todas las monedas</option>
                                        <option value="USD">USD</option>
                                        <option value="DOP">DOP</option>
                                        <option value="EUR">EUR</option>
                                        <option value="MXN">MXN</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search me-2"></i>Generar Reporte
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="reportResults" style="display: none;">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card dashboard-card bg-primary text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Total del Periodo</h5>
                                        <h2 class="card-text" id="reportTotal">&#x24;0.00</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card dashboard-card bg-success text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Promedio Diario</h5>
                                        <h2 class="card-text" id="reportAverage">&#x24;0.00</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card dashboard-card bg-info text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Total Transacciones</h5>
                                        <h2 class="card-text" id="reportCount">0</h2>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card dashboard-card">
                            <div class="card-body">
                                <canvas id="reportChart"></canvas>
                            </div>
                        </div>

                        <div class="table-responsive mt-4">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Receptor</th>
                                        <th>Tipo</th>
                                        <th>Monto</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="reportTransactions"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- New Transaction Modal -->
<div class="modal fade" id="newTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nueva Entrada de Dinero</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="transactionForm">
                    <div class="mb-3">
                        <label class="form-label">Receptor</label>
                        <select class="form-select" name="receiver" required>
                            <option value="Ismael">Ismael</option>
                            <option value="Pedro">Pedro</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" name="type" required>
                            <option value="tip">Propina</option>
                            <option value="commission">Comisi&#xf3;n</option>
                            <option value="sale">Venta</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Monto</label>
                        <input type="number" class="form-control" name="amount" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Moneda</label>
                        <select class="form-select" name="currency" required>
                            <option value="USD">USD - D&#xf3;lar Estadounidense</option>
                            <option value="DOP">DOP - Peso Dominicano</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="MXN">MXN - Peso Mexicano</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" name="observations"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="saveTransaction">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Updated Firebase SDK scripts -->
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

<!-- Add Chart.js before the closing </body> tag -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>let transactions = [];
let yearlyChart = null;
let currencyCharts = {};
let goals = {};
let reportChart = null;
document.addEventListener('DOMContentLoaded', function () {
  console.log('Initializing application...');
  const firebaseConfig = {
    apiKey: "AIzaSyDUirwoSQgvcMZn7uLjKMAxlTA15Jkl2BM",
    authDomain: "ismakun-bf0fa.firebaseapp.com",
    databaseURL: "https://ismakun-bf0fa-default-rtdb.firebaseio.com",
    projectId: "ismakun-bf0fa",
    storageBucket: "ismakun-bf0fa.firebasestorage.app",
    messagingSenderId: "1028877703945",
    appId: "1:1028877703945:web:331de48acbcdf2234a51d8"
  };
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const database = firebase.database();
  window.database = database;
  database.ref('.info/connected').on('value', function (snap) {
    if (snap.val() === true) {
      console.log('Connected to Firebase');
    } else {
      console.log('Disconnected from Firebase');
    }
  });
  database.ref('transactions').once('value').then(snapshot => {
    console.log('Initial data load successful');
  }).catch(error => {
    console.error('Error in initial data load:', error);
  });
  setupRealtimeListener();
  document.querySelector('a[data-bs-target="#transactions"]').addEventListener('click', updateTransactionsTab);
  document.querySelector('a[data-bs-target="#pending"]').addEventListener('click', updatePendingTab);
  ['filterReceiver', 'filterType', 'filterStatus', 'filterCurrency'].forEach(filterId => {
    document.getElementById(filterId).addEventListener('change', updateTransactionsTab);
  });
  document.getElementById('exportTransactions').addEventListener('click', exportTransactions);
  document.getElementById('saveTransaction').addEventListener('click', saveNewTransaction);
  document.getElementById('yearSelector').addEventListener('change', updateYearlyChart);
  initializeCurrencyDashboards();
  const cardHeaders = document.querySelectorAll('.currency-dashboard .card-header');
  cardHeaders.forEach(header => {
    const title = header.querySelector('h5').outerHTML;
    header.innerHTML = title;
  });
  document.getElementById('reportForm').addEventListener('submit', generateReport);
});
function setupRealtimeListener() {
  try {
    const transactionsRef = database.ref('transactions');
    transactionsRef.on('value', snapshot => {
      console.log('Data received from Firebase:', snapshot.val());
      transactions = [];
      snapshot.forEach(childSnapshot => {
        const transaction = {
          ...childSnapshot.val(),
          key: childSnapshot.key
        };
        transactions.push(transaction);
      });
      console.log('Processed transactions:', transactions);
      updateDashboard();
      updateTransactionsTab();
      updatePendingTab();
      updateCurrencyCharts();
    }, error => {
      console.error('Error fetching data:', error);
      alert('Error al cargar los datos. Por favor, recarga la página.');
    });
  } catch (error) {
    console.error('Setup error:', error);
    alert('Error al configurar la conexión con la base de datos.');
  }
}
function updateDashboard() {
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  const monthlyTotals = {
    USD: 0,
    DOP: 0,
    EUR: 0,
    MXN: 0
  };
  const ismaelDebts = {
    USD: 0,
    DOP: 0,
    EUR: 0,
    MXN: 0
  };
  const pedroDebts = {
    USD: 0,
    DOP: 0,
    EUR: 0,
    MXN: 0
  };
  transactions.forEach(transaction => {
    const transactionDate = new Date(transaction.date);
    const amount = parseFloat(transaction.amount);
    const currency = transaction.currency;
    if (transactionDate.getMonth() === currentMonth && transactionDate.getFullYear() === currentYear) {
      monthlyTotals[currency] += amount;
    }
    if (transaction.status === 'pending') {
      const splitAmount = amount / 2;
      if (transaction.receiver === 'Ismael') {
        ismaelDebts[currency] += splitAmount;
      } else {
        pedroDebts[currency] += splitAmount;
      }
    }
  });
  updateTotalsDisplay('monthlyTotal', monthlyTotals);
  updateTotalsDisplay('ismaelDebt', ismaelDebts);
  updateTotalsDisplay('pedroDebt', pedroDebts);
  document.querySelectorAll('.dashboard-card').forEach(card => {
    if (card.querySelector('.card-text')) {
      card.onclick = () => {
        const cardId = card.querySelector('.card-text').id;
        let details;
        if (cardId === 'monthlyTotal') {
          details = generateMonthlyTotalDetails(monthlyTotals);
        } else if (cardId === 'ismaelDebt') {
          details = generateDebtDetails('Ismael', ismaelDebts);
        } else if (cardId === 'pedroDebt') {
          details = generateDebtDetails('Pedro', pedroDebts);
        }
        if (details) {
          showDashboardCardDetails(details);
        }
      };
    }
  });
  updateRecentTransactions();
  updateYearlyChart();
}
function updateTotalsDisplay(elementId, totals) {
  const element = document.getElementById(elementId);
  const html = Object.entries(totals).filter(([_, amount]) => amount > 0).map(([currency, amount]) => `
            <div class="currency-amount">
                ${formatCurrency(amount, currency)}
            </div>
        `).join('');
  element.innerHTML = html || '$0.00';
}
function updateRecentTransactions() {
  const recentTransactionsTable = document.getElementById('recentTransactionsTable');
  const recentTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
  recentTransactionsTable.innerHTML = recentTransactions.map(transaction => `
        <tr>
            <td>${new Date(transaction.date).toLocaleDateString()}</td>
            <td>${transaction.receiver}</td>
            <td><span class="badge bg-info">${transaction.type === 'tip' ? 'Propina' : transaction.type === 'commission' ? 'Comisión' : 'Venta'}</span></td>
            <td class="text-end">
                <span class="currency-symbol">${transaction.currency}</span> 
                ${parseFloat(transaction.amount).toFixed(2)}
            </td>
            <td>
                <span class="badge ${transaction.status === 'pending' ? 'bg-warning' : 'bg-success'}">
                    ${transaction.status === 'pending' ? 'Pendiente' : 'Pagado'}
                </span>
            </td>
        </tr>
    `).join('') || `
        <tr>
            <td colspan="5" class="text-center p-3">
                <i class="fas fa-info-circle me-2"></i>
                No hay transacciones recientes
            </td>
        </tr>
    `;
}
function saveNewTransaction() {
  const form = document.getElementById('transactionForm');
  const formData = new FormData(form);
  const newTransaction = {
    receiver: formData.get('receiver'),
    type: formData.get('type'),
    amount: parseFloat(formData.get('amount')),
    currency: formData.get('currency'),
    observations: formData.get('observations') || '',
    date: new Date().toISOString(),
    status: 'pending'
  };
  if (!newTransaction.amount || isNaN(newTransaction.amount)) {
    alert('Por favor ingrese un monto válido');
    return;
  }
  document.getElementById('loadingIndicator').style.display = 'block';
  database.ref('transactions').push(newTransaction).then(() => {
    const modal = bootstrap.Modal.getInstance(document.getElementById('newTransactionModal'));
    modal.hide();
    form.reset();
    alert('Transacción guardada exitosamente');
  }).catch(error => {
    console.error('Error saving transaction:', error);
    alert('Error al guardar la transacción: ' + error.message);
  }).finally(() => {
    document.getElementById('loadingIndicator').style.display = 'none';
  });
}
function updateTransactionsTab() {
  const transactionsTableBody = document.getElementById('transactionsTableBody');
  transactionsTableBody.innerHTML = '';
  let filteredTransactions = [...transactions];
  const filterReceiver = document.getElementById('filterReceiver').value;
  const filterType = document.getElementById('filterType').value;
  const filterStatus = document.getElementById('filterStatus').value;
  const filterCurrency = document.getElementById('filterCurrency').value;
  if (filterReceiver) {
    filteredTransactions = filteredTransactions.filter(t => t.receiver === filterReceiver);
  }
  if (filterType) {
    filteredTransactions = filteredTransactions.filter(t => t.type === filterType);
  }
  if (filterStatus) {
    filteredTransactions = filteredTransactions.filter(t => t.status === filterStatus);
  }
  if (filterCurrency) {
    filteredTransactions = filteredTransactions.filter(t => t.currency === filterCurrency);
  }
  filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
  filteredTransactions.forEach(transaction => {
    const row = document.createElement('tr');
    const date = new Date(transaction.date).toLocaleDateString();
    let typeLabel = {
      'tip': 'Propina',
      'commission': 'Comisión',
      'sale': 'Venta'
    }[transaction.type] || transaction.type;
    row.innerHTML = `
            <td>${date}</td>
            <td>${transaction.receiver}</td>
            <td><span class="badge bg-info">${typeLabel}</span></td>
            <td class="text-end">
                <span class="currency-symbol">${transaction.currency}</span> 
                ${parseFloat(transaction.amount).toFixed(2)}
            </td>
            <td>
                <span class="badge ${transaction.status === 'pending' ? 'bg-warning' : 'bg-success'}">
                    ${transaction.status === 'pending' ? 'Pendiente' : 'Pagado'}
                </span>
            </td>
            <td>${transaction.observations || '-'}</td>
            <td>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="editTransaction('${transaction.key}')" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="markAsPaid('${transaction.key}')" 
                            title="Marcar como pagado" ${transaction.status === 'paid' ? 'disabled' : ''}>
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction('${transaction.key}')" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
    transactionsTableBody.appendChild(row);
  });
  if (filteredTransactions.length === 0) {
    transactionsTableBody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center p-3">
                    <i class="fas fa-search me-2"></i>
                    No se encontraron transacciones
                </td>
            </tr>
        `;
  }
}
function updatePendingTab() {
  const pendingTab = document.getElementById('pending');
  const pendingTransactions = transactions.filter(t => t.status === 'pending');
  pendingTab.innerHTML = `
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1>Transacciones Pendientes</h1>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Receptor</th>
                        <th>Tipo</th>
                        <th>Monto</th>
                        <th>Observaciones</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    ${pendingTransactions.length ? pendingTransactions.map(t => `
                        <tr>
                            <td>${new Date(t.date).toLocaleDateString()}</td>
                            <td>${t.receiver}</td>
                            <td><span class="badge bg-info">${t.type === 'tip' ? 'Propina' : t.type === 'commission' ? 'Comisión' : 'Venta'}</span></td>
                            <td>
                                <span class="currency-symbol">${t.currency}</span> 
                                ${parseFloat(t.amount).toFixed(2)}
                            </td>
                            <td>${t.observations || '-'}</td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-success" onclick="markAsPaid('${t.key}')" title="Marcar como pagado">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('') : `
                        <tr>
                            <td colspan="6" class="text-center p-3">
                                <i class="fas fa-check-circle me-2"></i>
                                No hay transacciones pendientes
                            </td>
                        </tr>
                    `}
                </tbody>
            </table>
        </div>
    `;
}
function formatCurrency(amount, currency) {
  const formatter = new Intl.NumberFormat('es-DO', {
    style: 'currency',
    currency: currency,
    minimumFractionDigits: 2
  });
  return formatter.format(amount);
}
function editTransaction(key) {
  const transaction = transactions.find(t => t.key === key);
  if (!transaction) return;
  const form = document.getElementById('transactionForm');
  form.querySelector('[name="receiver"]').value = transaction.receiver;
  form.querySelector('[name="type"]').value = transaction.type;
  form.querySelector('[name="amount"]').value = transaction.amount;
  form.querySelector('[name="currency"]').value = transaction.currency;
  form.querySelector('[name="observations"]').value = transaction.observations || '';
  const modal = new bootstrap.Modal(document.getElementById('newTransactionModal'));
  modal.show();
  document.getElementById('saveTransaction').onclick = function () {
    const formData = new FormData(form);
    const updatedTransaction = {
      ...transaction,
      receiver: formData.get('receiver'),
      type: formData.get('type'),
      amount: parseFloat(formData.get('amount')),
      currency: formData.get('currency'),
      observations: formData.get('observations')
    };
    database.ref(`transactions/${key}`).update(updatedTransaction).then(() => {
      modal.hide();
      form.reset();
    }).catch(error => {
      console.error('Error updating transaction:', error);
      alert('Error updating transaction. Please try again.');
    });
  };
}
function markAsPaid(key) {
  if (confirm('¿Marcar esta transacción como pagada?')) {
    database.ref(`transactions/${key}`).update({
      status: 'paid'
    }).catch(error => {
      console.error('Error updating transaction status:', error);
      alert('Error updating transaction status. Please try again.');
    });
  }
}
function deleteTransaction(key) {
  if (confirm('¿Estás seguro de que quieres eliminar esta transacción?')) {
    database.ref(`transactions/${key}`).remove().catch(error => {
      console.error('Error deleting transaction:', error);
      alert('Error deleting transaction. Please try again.');
    });
  }
}
function updateYearlyChart() {
  if (yearlyChart) {
    yearlyChart.destroy();
  }
  const years = [...new Set(transactions.map(t => new Date(t.date).getFullYear()))].sort();
  const yearSelector = document.getElementById('yearSelector');
  yearSelector.innerHTML = years.map(year => `<option value="${year}">${year}</option>`).join('');
  const selectedYear = yearSelector.value || Math.max(...years);
  const monthlyTotals = Array(12).fill(0).map(() => ({
    USD: 0,
    DOP: 0,
    EUR: 0,
    MXN: 0
  }));
  transactions.forEach(transaction => {
    const date = new Date(transaction.date);
    if (date.getFullYear() === parseInt(selectedYear)) {
      const month = date.getMonth();
      const amount = parseFloat(transaction.amount);
      monthlyTotals[month][transaction.currency] += amount;
    }
  });
  const datasets = Object.keys(monthlyTotals[0]).map(currency => ({
    label: currency,
    data: monthlyTotals.map(month => month[currency]),
    borderWidth: 2,
    tension: 0.4
  }));
  const ctx = document.getElementById('yearlyChart').getContext('2d');
  const options = {
    responsive: true,
    plugins: {
      legend: {
        position: 'top'
      },
      title: {
        display: true,
        text: `Total Acumulado por Mes - ${selectedYear}`
      }
    },
    scales: {
      y: {
        beginAtZero: true
      }
    },
    onClick: (event, elements) => {
      if (elements.length > 0) {
        const element = elements[0];
        const label = yearlyChart.data.labels[element.index];
        const value = yearlyChart.data.datasets[element.datasetIndex].data[element.index];
        const currency = yearlyChart.data.datasets[element.datasetIndex].label;
        showChartDetail('yearly', label, value, currency);
      }
    }
  };
  yearlyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
      datasets: datasets
    },
    options: options
  });
}
function initializeCurrencyDashboards() {
  const currencies = ['USD', 'DOP', 'EUR', 'MXN'];
  const colors = {
    USD: 'rgb(13, 110, 253)',
    DOP: 'rgb(25, 135, 84)',
    EUR: 'rgb(13, 202, 240)',
    MXN: 'rgb(255, 193, 7)'
  };
  const chartOptions = {
    responsive: true,
    plugins: {
      legend: {
        display: false
      }
    },
    scales: {
      y: {
        beginAtZero: true
      }
    },
    onClick: function (event, elements, chart) {
      if (elements.length > 0) {
        const element = elements[0];
        const chartCurrency = chart.canvas.id.replace('Chart', '').toUpperCase();
        const label = chart.data.labels[element.index];
        const value = chart.data.datasets[0].data[element.index];
        showChartDetail('currency', label, value, chartCurrency);
      }
    }
  };
  currencies.forEach(currency => {
    const ctx = document.getElementById(`${currency.toLowerCase()}Chart`).getContext('2d');
    currencyCharts[currency] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: `${currency} Income`,
          data: [],
          borderColor: colors[currency],
          tension: 0.4
        }]
      },
      options: {
        ...chartOptions,
        plugins: {
          ...chartOptions.plugins,
          legend: {
            display: false
          }
        }
      }
    });
    currencyCharts[currency].options.onClick = function (event, elements) {
      if (elements.length > 0) {
        const element = elements[0];
        const label = currencyCharts[currency].data.labels[element.index];
        const value = currencyCharts[currency].data.datasets[0].data[element.index];
        showChartDetail('currency', label, value, currency);
      }
    };
  });
}
function updateCurrencyCharts() {
  const currencies = ['USD', 'DOP', 'EUR', 'MXN'];
  const monthlyData = {};
  currencies.forEach(currency => {
    monthlyData[currency] = Array(12).fill(0);
  });
  transactions.forEach(transaction => {
    const date = new Date(transaction.date);
    const month = date.getMonth();
    const amount = parseFloat(transaction.amount);
    monthlyData[transaction.currency][month] += amount;
  });
  currencies.forEach(currency => {
    const chart = currencyCharts[currency];
    chart.data.labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    chart.data.datasets[0].data = monthlyData[currency];
    chart.update();
    const currentTotal = monthlyData[currency].reduce((a, b) => a + b, 0);
    document.getElementById(`${currency.toLowerCase()}Current`).textContent = currentTotal.toFixed(2);
    updateGoalProgress(currency);
  });
}
function updateGoalProgress(currency) {
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  const monthlyTotal = transactions.filter(t => {
    const transDate = new Date(t.date);
    return t.currency === currency && transDate.getMonth() === currentMonth && transDate.getFullYear() === currentYear;
  }).reduce((sum, t) => sum + parseFloat(t.amount), 0);
  goals[currency] = monthlyTotal;
  document.getElementById(`${currency.toLowerCase()}Goal`).textContent = monthlyTotal.toFixed(2);
  document.getElementById(`${currency.toLowerCase()}Progress`).style.width = '100%';
}
function setGoal(currency) {
  return;
}
function saveGoal() {
  return;
}
function generateMonthlyTotalDetails(monthlyTotals) {
  const currencies = Object.entries(monthlyTotals).filter(([_, amount]) => amount > 0);
  const totalSum = currencies.reduce((sum, [_, amount]) => sum + amount, 0);
  return {
    title: 'Detalles del Total Mensual',
    content: `
      <div class="chart-detail-header mb-4">
        <div class="row align-items-center">
          <div class="col">
            <h4 class="mb-0">Resumen del Mes Actual</h4>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card bg-light">
            <div class="card-body text-center">
              <h6 class="card-subtitle mb-2 text-muted">Total Divisas</h6>
              <h3 class="card-title mb-0">${currencies.length}</h3>
            </div>
          </div>
        </div>
      </div>

      <div class="currency-breakdown">
        <h5 class="mb-3">Desglose por Divisa</h5>
        ${currencies.map(([currency, amount]) => `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="currency-detail">
              <i class="fas ${getCurrencyIcon(currency)} me-2"></i>
              <span class="fw-bold">${currency}</span>
            </span>
            <span class="badge bg-primary fs-6">
              ${formatCurrency(amount, currency)}
            </span>
          </div>
        `).join('')}
      </div>
    `
  };
}
function getCurrencyIcon(currency) {
  const icons = {
    USD: 'fa-dollar-sign',
    EUR: 'fa-euro-sign',
    DOP: 'fa-money-bill-wave',
    MXN: 'fa-peso-sign'
  };
  return icons[currency] || 'fa-money-bill';
}
function generateDebtDetails(person, debts) {
  const currencies = Object.entries(debts).filter(([_, amount]) => amount > 0);
  const totalUSD = currencies.reduce((sum, [curr, amount]) => {
    return sum + amount;
  }, 0);
  const otherPerson = person === 'Ismael' ? 'Nathanael' : 'Ismael';
  return {
    title: `Detalles de Deuda - ${person}`,
    content: `
      <div class="chart-detail-header mb-4">
        <div class="row align-items-center">
          <div class="col">
            <h4 class="mb-0">${person} debe a ${otherPerson}</h4>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card bg-light">
            <div class="card-body text-center">
              <h6 class="card-subtitle mb-2 text-muted">Divisas Pendientes</h6>
              <h3 class="card-title mb-0">${currencies.length}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card bg-light">
            <div class="card-body text-center">
              <h6 class="card-subtitle mb-2 text-muted">Total USD</h6>
              <h3 class="card-title mb-0">$${totalUSD.toFixed(2)}</h3>
            </div>
          </div>
        </div>
      </div>

      <div class="debt-breakdown">
        <h5 class="mb-3">Desglose de Deudas</h5>
        ${currencies.map(([currency, amount]) => `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="fw-bold">${currency}</span>
            <span class="badge bg-warning text-dark fs-6">${formatCurrency(amount, currency)}</span>
          </div>
        `).join('')}
      </div>
    `
  };
}
function showChartDetail(type, label, value, currency) {
  const modalContent = document.getElementById('chartDetailContent');
  const filteredTransactions = transactions.filter(t => {
    const date = new Date(t.date);
    if (type === 'yearly') {
      return date.toLocaleString('default', {
        month: 'long'
      }) === label && t.currency === currency;
    } else {
      return t.currency === currency && date.toLocaleString('default', {
        month: 'short'
      }) === label;
    }
  });
  let html = `
        <div class="chart-detail-header mb-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-0">
                        <span class="badge bg-primary">${currency}</span>
                        <span class="ms-2">${label}</span>
                    </h4>
                </div>
                <div class="col-md-6 text-md-end">
                    <h5 class="text-success mb-0">
                        Total: ${formatCurrency(value, currency)}
                    </h5>
                </div>
            </div>
        </div>

        <div class="chart-detail-stats row mb-4">
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">Transacciones</h6>
                        <h3 class="card-title mb-0">${filteredTransactions.length}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">Promedio</h6>
                        <h3 class="card-title mb-0">
                            ${formatCurrency(value / (filteredTransactions.length || 1), currency)}
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">Mayor Transacción</h6>
                        <h3 class="card-title mb-0">
                            ${formatCurrency(Math.max(...filteredTransactions.map(t => t.amount), 0), currency)}
                        </h3>
                    </div>
                </div>
            </div>
        </div>

        <h5 class="mb-3">
            <i class="fas fa-list-ul me-2"></i>
            Detalle de Transacciones
        </h5>
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Fecha</th>
                        <th>Receptor</th>
                        <th>Tipo</th>
                        <th class="text-end">Monto</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
    `;
  if (filteredTransactions.length > 0) {
    filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
    filteredTransactions.forEach(t => {
      html += `
                <tr>
                    <td>${new Date(t.date).toLocaleDateString()}</td>
                    <td>${t.receiver}</td>
                    <td>
                        <span class="badge bg-info">
                            ${t.type === 'tip' ? 'Propina' : t.type === 'commission' ? 'Comisión' : 'Venta'}
                        </span>
                    </td>
                    <td class="text-end fw-bold">${formatCurrency(t.amount, t.currency)}</td>
                    <td>
                        <span class="badge ${t.status === 'pending' ? 'bg-warning' : 'bg-success'}">
                            ${t.status === 'pending' ? 'Pendiente' : 'Pagado'}
                        </span>
                    </td>
                </tr>
            `;
    });
  } else {
    html += `
            <tr>
                <td colspan="5" class="text-center p-4">
                    <i class="fas fa-info-circle text-muted me-2"></i>
                    No se encontraron transacciones para este período
                </td>
            </tr>
        `;
  }
  html += `
                </tbody>
            </table>
        </div>
    `;
  modalContent.innerHTML = html;
  const modal = new bootstrap.Modal(document.getElementById('chartDetailModal'));
  modal.show();
}
function showDashboardCardDetails(details) {
  const modalContent = document.getElementById('chartDetailContent');
  modalContent.innerHTML = details.content;
  const modalTitle = document.querySelector('#chartDetailModal .modal-title');
  modalTitle.innerHTML = `<i class="fas fa-chart-bar me-2"></i>${details.title}`;
  const modal = new bootstrap.Modal(document.getElementById('chartDetailModal'));
  modal.show();
}
function generateReport(e) {
  e.preventDefault();
  const startDate = new Date(document.getElementById('startDate').value);
  const endDate = new Date(document.getElementById('endDate').value);
  const currency = document.getElementById('reportCurrency').value;
  const filteredTransactions = transactions.filter(t => {
    const transDate = new Date(t.date);
    return transDate >= startDate && transDate <= endDate && (currency ? t.currency === currency : true);
  });
  const totals = filteredTransactions.reduce((acc, t) => {
    if (!acc[t.currency]) acc[t.currency] = 0;
    acc[t.currency] += parseFloat(t.amount);
    return acc;
  }, {});
  const totalHtml = Object.entries(totals).map(([curr, amount]) => formatCurrency(amount, curr)).join('<br>');
  document.getElementById('reportTotal').innerHTML = totalHtml || '$0.00';
  const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
  const averages = Object.entries(totals).map(([curr, total]) => formatCurrency(total / days, curr)).join('<br>');
  document.getElementById('reportAverage').innerHTML = averages || '$0.00';
  document.getElementById('reportCount').textContent = filteredTransactions.length;
  updateReportChart(filteredTransactions, startDate, endDate);
  const tableBody = document.getElementById('reportTransactions');
  tableBody.innerHTML = filteredTransactions.map(t => `
      <tr>
          <td>${new Date(t.date).toLocaleDateString()}</td>
          <td>${t.receiver}</td>
          <td><span class="badge bg-info">
              ${t.type === 'tip' ? 'Propina' : t.type === 'commission' ? 'Comisión' : 'Venta'}
          </span></td>
          <td>${formatCurrency(t.amount, t.currency)}</td>
          <td><span class="badge ${t.status === 'pending' ? 'bg-warning' : 'bg-success'}">
              ${t.status === 'pending' ? 'Pendiente' : 'Pagado'}
          </span></td>
      </tr>
  `).join('') || '<tr><td colspan="5" class="text-center">No se encontraron transacciones</td></tr>';
  document.getElementById('reportResults').style.display = 'block';
}
function updateReportChart(filteredTransactions, startDate, endDate) {
  if (reportChart) {
    reportChart.destroy();
  }
  const dateLabels = [];
  const currentDate = new Date(startDate);
  while (currentDate <= endDate) {
    dateLabels.push(new Date(currentDate).toLocaleDateString());
    currentDate.setDate(currentDate.getDate() + 1);
  }
  const currencies = [...new Set(filteredTransactions.map(t => t.currency))];
  const datasets = currencies.map(currency => {
    const data = dateLabels.map(date => {
      return filteredTransactions.filter(t => new Date(t.date).toLocaleDateString() === date && t.currency === currency).reduce((sum, t) => sum + parseFloat(t.amount), 0);
    });
    return {
      label: currency,
      data: data,
      borderWidth: 2,
      tension: 0.4
    };
  });
  const ctx = document.getElementById('reportChart').getContext('2d');
  reportChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dateLabels,
      datasets: datasets
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Ingresos Diarios por Moneda'
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}</script>

</body>
</html>
